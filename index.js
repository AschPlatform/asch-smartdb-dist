module.exports=function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i.w={},i(i.s=24)}([function(e,t){e.exports=require("util")},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.All=127]="All",e[e.Trace=64]="Trace",e[e.Debug=32]="Debug",e[e.Log=16]="Log",e[e.Info=8]="Info",e[e.Warn=4]="Warn",e[e.Error=2]="Error",e[e.Fatal=1]="Fatal",e[e.None=0]="None"}(n=t.LogLevel||(t.LogLevel={}));class r{get infoEnabled(){return(this.level&n.Info)>0}get traceEnabled(){return(this.level&n.Trace)>0}get debugEnabled(){return(this.level&n.Debug)>0}get logEnabled(){return(this.level&n.Log)>0}get warnEnabled(){return(this.level&n.Warn)>0}get errorEnaled(){return(this.level&n.Error)>0}get fatalEnabled(){return(this.level&n.Fatal)>0}get logLevel(){return this.level}set logLevel(e){this.level=e}constructor(e,t,i,n){this.name=e,this.level=n,this.format=i,this.logger=t}fromatMessage(e,t){return`${(new Date).toLocaleTimeString()} [${t}] [${this.name}] ${e}`}info(e,...t){e=this.format?this.fromatMessage(e,"INFO"):e,this.logger.info(e,...t)}debug(e,...t){e=this.format?this.fromatMessage(e,"DEBUG"):e,this.logger.debug(e,...t)}log(e,...t){e=this.format?this.fromatMessage(e,"LOG"):e,this.logger.debug(e,...t)}trace(e,...t){e=this.format?this.fromatMessage(e,"TRACE"):e,this.logger.debug(e,...t)}warn(e,...t){e=this.format?this.fromatMessage(e,"WARN"):e,this.logger.warn(e,...t)}error(e,t){e=this.format?this.fromatMessage(e,"ERROR"):e,this.logger.error(e,t)}fatal(e,t){e=this.format?this.fromatMessage(e,"FATAL"):e,this.logger.error(e,t)}}class s{static get defaultLogger(){return s.consoleLogger=s.consoleLogger||new r("default",console,!0,s.defaultLogLevel),s.consoleLogger}static set defaultLevel(e){s.defaultLogLevel=e}static set logFactory(e){s.factory=e}static getLogger(e){if(!s.logFactory)return s.defaultLogger;const t=s.factory.create(e),i=s.factory.level,n=s.factory.format;return new r(e||"",t,n,i)}}s.defaultLogLevel=n.All,s.factory={create:e=>console,format:!0,level:s.defaultLogLevel},t.LogManager=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.makeJsonObject=function(e,t,i){s.argument("iterable",()=>s.notNull(e)),s.argument("getKey",()=>s.notNull(t)),s.argument("getValue",()=>s.notNull(i));let n={};for(let r of e)n[t(r)]=i(r);return n},t.deepCopy=function(e){return e?JSON.parse(JSON.stringify(e)):e},t.partial=function(e,t){s.argument("src",()=>s.notNull(e)),s.argument("keysOrKeyFilter",()=>s.notNull(t));let i=n.isFunction(t)?Object.keys(e).filter(t):t,r={};for(let t of i)r[t]=e[t];return r},t.isPrimitiveKey=function(e){return!!e&&(n.isString(e)||n.isNumber(e))};class r extends Error{constructor(e){super("Code contract Error,"+e)}}t.CodeContractError=r;class s{static verify(e,t){if(void 0===e||null===e)throw new Error("Invalid verify condition");const i=n.isFunction(e)?e():e,s=n.isFunction(t)?t():t;if(!i)throw new r(s)}static argument(e,t,i){if(!e||!t)throw new Error("argName or verify cannot be null or undefined");if(i)s.verify(t,i);else{const i=t();s.verify(i.result,`argument '${e}' ${i.message}`)}}static notNull(e){const t=null!==e&&void 0!==e;return{result:t,message:t?void 0:"cannot be null or undefined"}}static notNullOrEmpty(e){const t=s.notNull(e)&&""!==e;return{result:t,message:t?void 0:"cannot be null or undefined or empty"}}static notNullOrWhitespace(e){const t=s.notNullOrEmpty(e)&&""!==e.trim();return{result:t,message:t?void 0:"cannot be null or undefined or whitespace"}}}t.CodeContract=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(2);var s;!function(e){e.String="String",e.Number="Number",e.BigInt="BigInt",e.Text="Text"}(s=t.FieldTypes||(t.FieldTypes={}));class o{constructor(e){r.CodeContract.argument("keyObject",()=>r.CodeContract.notNull(e)),this.keyObject=e}static make(e,t){return r.CodeContract.argument("schema",()=>r.CodeContract.notNull(e)),r.CodeContract.argument("schema",e.isCompsiteKey,"model must indentify by composite key"),r.CodeContract.argument("entity",()=>r.CodeContract.notNull(t)),new o(r.partial(t,e.compositeKeys))}static fromString(e){return r.CodeContract.argument("keyJsonString",()=>r.CodeContract.notNullOrWhitespace(e)),new o(JSON.parse(e).keyObject)}get keyJson(){return this.keyObject}get key(){return JSON.stringify(this.keyObject)}toString(){return this.key}}t.CompositeKey=o,t.isCompositeKey=function(e){return!!e&&e.keyJson};t.ModelSchema=class{constructor(e,t){this.schema=Object.assign({},e),this.name=t,this.memory=!0===e.memory,this.readonly=!0===e.readonly,this.local=!0===e.local,this.attachVersionField(this.schema),this.parseFields(),this.prototypeObject={},this.setDefaultValues(this.prototypeObject)}attachVersionField(e){e.tableFields.find(e=>"_version_"===e.name)||e.tableFields.push({name:"_version_",type:s.Number,default:0})}convertType(e){return e}parseFields(){const e=this.schema.tableFields.filter(e=>!0===e.primary_key).map(e=>e.name);if(this.cKeys=this.schema.tableFields.filter(e=>!0===e.composite_key).map(e=>e.name),this.pKey=1===e.length?e[0]:void 0,void 0!==this.pKey==this.cKeys.length>1)throw new Error("model must have primary key or composite keys, but can not both");this.allFieldTypes=new Map,this.schema.tableFields.forEach(e=>this.allFieldTypes.set(e.name,this.convertType(e.type))),this.allFields=this.schema.tableFields.map(e=>e.name),this.allIndexes=this.schema.tableFields.filter(e=>!0===e.index).map(e=>e.name)}getFieldTypes(e){return this.allFieldTypes}get schemaObject(){return this.schema}get isCompsiteKey(){return this.compositeKeys.length>1}get primaryKey(){return this.pKey}get compositeKeys(){return this.cKeys}get fieldNames(){return this.allFields}get indexes(){return this.allIndexes}get modelName(){return this.name}get isLocal(){return this.local}get isReadonly(){return this.readonly}get memCached(){return this.memory}setKey(e,t){if(this.isCompsiteKey){const i=t;this.cKeys.forEach(t=>e[t]=i.keyJson[t])}else e[this.primaryKey]=t;return e}getKey(e){return this.isCompsiteKey?o.make(this,e):e[this.primaryKey]}newEntity(e,t){let i=n.isString(e)?{}:new e;return this.setDefaultValues(i),this.setKey(i,t)}setDefaultValues(e){this.schema.tableFields.forEach(t=>{void 0!==t.default&&(e[t.name]=t.default)})}copyProperties(e,t,i=!1){this.allFields.forEach(n=>{(i||this.cKeys.indexOf(n)<0&&n!==this.primaryKey)&&void 0!==t[n]&&(e[n]=t[n])})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(6),s=i(1);var o;!function(e){e[e.Transient=-1]="Transient",e[e.Persistent=0]="Persistent",e[e.New=1]="New",e[e.Modified=2]="Modified",e[e.Deleted=3]="Deleted"}(o=t.EntityState||(t.EntityState={}));class a{constructor(e){this.tracker=e,this.log=s.LogManager.getLogger(a.name)}static isExtended(e){return e.hasOwnProperty("__schema__")&&e.hasOwnProperty("__state__")}static isProxied(e){return a.isExtended(e)}static convertToProxied(e){if(!a.isProxied(e))throw new Error("Invalid Proxied Entity");return e}static proxyToEntity(e,t=!0){return t?n.partial(e,e=>a.isNormalProperty(e)):n.partial(e,e=>"_version_"!==e&&a.isNormalProperty(e))}static isNormalProperty(e){return e.length<=4||e[0]!==e[1]||"_"!==e[0]||!e.endsWith("__")}attachExtendProperties(e,t,i,n){let r=Object.assign({_version_:1,__detached__:!1,__state__:i,__confirmed__:n,__schema__:t,__tracker__:this.tracker,__tracking__:!0,__changes__:null,__unconfirmedChanges__:null},e);return r._version_=r._version_||1,r}static initChanges(e,t=r.EntityChangeType.Modify){t===r.EntityChangeType.Modify&&(e.__changes__={type:r.EntityChangeType.Modify,dbVersion:e._version_,propertiesChanges:new Array({name:"_version_",original:e._version_-1,current:e._version_})}),e.__unconfirmedChanges__={type:t,dbVersion:e._version_,propertiesChanges:new Array}}getPropertyKeys(e){return e.__schema__.fieldNames}onPropertySet(e,t,i,n){const r=e,s=t.toString();if(!a.isNormalProperty(s)||!r.__tracking__||i===e[t])return e[t]=i,!0;if(r.__state__===o.Deleted||r.__state__===o.Transient)throw new Error("Can not modify property after deleted");let c=r.__schema__;if(c.isReadonly)throw new Error(`Can not modify readonly model '${c.modelName}'`);if(c.primaryKey===s||c.compositeKeys.indexOf(s)>=0)throw new Error("Can not modify primary key or composite key property");return r.__detached__&&(r.__tracker__.attach(n),r.__detached__=!1),a.recordPropertyChanges(r,t,i),e[t]=i,!0}static recordPropertyChanges(e,t,i){let n=!1;e.__tracker__.isConfirming&&e.__confirmed__&&(n=!0,e.__confirmed__=!1),e.__tracker__.isConfirming&&e.__tracker__.registerUnconfirmedEntity(e),e.__state__===o.Persistent&&(e._version_++,e.__state__=o.Modified,a.initChanges(e));let s=null;e.__state__===o.Modified?s=e.__confirmed__?e.__changes__.propertiesChanges:e.__unconfirmedChanges__.propertiesChanges:e.__state__===o.New&&e.__tracker__.isConfirming&&(n&&a.initChanges(e,r.EntityChangeType.New),s=null===e.__unconfirmedChanges__?void 0:e.__unconfirmedChanges__.propertiesChanges);let c=t.toString();s&&s.push({name:c,original:e[c],current:i})}static isDirty(e){const t=a.convertToProxied(e).__state__;return!(t===o.Persistent||t===o.Transient)}proxyNew(e,t,i){let n=this.attachExtendProperties(e,t,o.New,i);return new Proxy(n,{set:this.onPropertySet,ownKeys:this.getPropertyKeys})}proxyPersistent(e,t,i){let n=this.attachExtendProperties(e,t,o.Persistent,i);return new Proxy(n,{set:this.onPropertySet,ownKeys:this.getPropertyKeys})}confirmChanges(e){if(e.__confirmed__)return void(this.log.infoEnabled&&this.log.info("confirm when confirmed"));let t=e.__unconfirmedChanges__;t&&e.__changes__?e.__changes__.propertiesChanges.push(...t.propertiesChanges):e.__changes__||(e.__changes__=n.deepCopy(t)),e.__confirmed__=!0,e.__unconfirmedChanges__&&(e.__unconfirmedChanges__.propertiesChanges=new Array)}cancelChanges(e){e.__confirmed__?this.log.infoEnabled&&this.log.info("cancel when confirmed"):(e.__tracking__=!1,e.__unconfirmedChanges__&&e.__unconfirmedChanges__.propertiesChanges.forEach(t=>e[t.name]=t.original),e.__tracking__=!0,e.__state__===o.Modified&&(e.__state__=e.__changes__?o.Modified:o.Persistent),e.__confirmed__=!0,e.__unconfirmedChanges__&&(e.__unconfirmedChanges__.propertiesChanges=new Array))}}t.EntityProxy=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(11),s=i(7);class o{constructor(e){this.connection=e}commit(){return n(this,void 0,void 0,function*(){yield this.connection.execute("COMMIT;")})}rollback(){return n(this,void 0,void 0,function*(){yield this.connection.execute("ROLLBACK;")})}}t.SqliteConnection=class{constructor(e){this.options=e,this.sqlite=new r.SqliteWrapper}get connectionOptions(){return this.options}get isConnected(){return this.sqlite.isConnected}connect(){return n(this,void 0,void 0,function*(){return this.sqlite.asynOpen(this.options.storage)})}disconnect(){return n(this,void 0,void 0,function*(){return yield this.sqlite.asynClose()})}query(e,t){return n(this,void 0,void 0,function*(){return yield this.sqlite.asynQuery(e,t)})}querySync(e,t){return this.sqlite.query(e,t)}ensureExecuteEffected(e){if(0===e.rowsEffected)throw new Error("None row effected")}executeBatchSync(e){return this.sqlite.executeBatch(e||[],this.ensureExecuteEffected)}executeBatch(e){return n(this,void 0,void 0,function*(){return yield this.sqlite.asyncExecuteBatch(e||[],this.ensureExecuteEffected)})}executeSync(e,t,i=!1){const n=this.sqlite.execute(e,t);return i&&this.ensureExecuteEffected(n),n}execute(e,t,i=!1){return n(this,void 0,void 0,function*(){const n=yield this.sqlite.asynExecute(e,t);return i&&this.ensureExecuteEffected(n),n})}runScript(e){return n(this,void 0,void 0,function*(){e.split(s.MULTI_SQL_SEPARATOR).forEach(e=>n(this,void 0,void 0,function*(){return(yield""!==e.trim())&&this.sqlite.execute(e,[])}))})}beginTrans(){return n(this,void 0,void 0,function*(){return yield this.execute("BEGIN TRANSACTION;"),new o(this)})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(2),s=i(0);var o;!function(e){e[e.New=1]="New",e[e.Modify=2]="Modify",e[e.Delete=3]="Delete"}(o=t.EntityChangeType||(t.EntityChangeType={}));t.BaseEntityTracker=class{constructor(e,t){this.log=t,this.cache=e,this.confirming=!1,this.history=new Map,this.minVersion=-1,this.currentVersion=-1}makeModelAndKey(e,t){let i={m:e.modelName,k:t};return JSON.stringify(i)}splitModelAndKey(e){let t=JSON.parse(e),i=s.isString(t.k)||s.isNumber(t.k)?t.k:new n.CompositeKey(t.k.keyObject);return{model:t.m,key:i}}attachHistory(e){if(this.log.infoEnabled&&this.log.info(`BEGIN attachHistory history info = ${JSON.stringify(this.historyVersion)}`),e.forEach((e,t)=>{let i=new Map;e.forEach(e=>i.set(e.modelAndKey,e.changes)),this.history.set(t,i)}),this.log.infoEnabled){let t=new Array;e.forEach((e,i)=>t.push(i)),this.log.info(`SUCCESS attachHistory height = ${JSON.stringify(t)}`)}}get historyVersion(){return{min:this.minVersion,max:this.currentVersion}}getHistoryByVersion(e,t=!1){return!this.history.has(e)&&t&&this.history.set(e,new Map),this.history.get(e)}getChangesUntil(e){const t=new Array;let i=this.currentVersion;for(;i>=e;){let e=this.getHistoryByVersion(i);e&&t.push(e),i--}return t}rollbackCacheChanges(e,t,i){switch(i.type){case o.New:this.cache.evit(e,t);break;case o.Modify:let n=this.cache.get(e,t);if(void 0===n)return;i.propertiesChanges.forEach(e=>n[e.name]=e.original),this.cache.put(e,t,n);break;case o.Delete:const s=r.makeJsonObject(i.propertiesChanges,e=>e.name,e=>e.original);this.cache.put(e,t,s)}}clearHistory(e){if(!(this.minVersion>=e||this.currentVersion<e))for(let t=this.minVersion;t<e;t++)this.history.delete(t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(0),s=i(14)({separatedValues:!1}),o=i(13);var a;t.MULTI_SQL_SEPARATOR=";",function(e){e[e.Schema=0]="Schema",e[e.Select=1]="Select",e[e.Insert=2]="Insert",e[e.Update=3]="Update",e[e.Delete=4]="Delete",e[e.Other=9]="Other"}(a=t.SqlType||(t.SqlType={}));t.JsonSqlBuilder=class{getTableName(e){return o.snakeCase(e)+"s"}getPrimaryKeyCondition(e,t){return e.setKey({},t)}buildSchema(e){let t=new Array;const i=Object.assign({type:"create"},n.deepCopy(e.schemaObject));let r=s.build(i);t.push(r.query);const o=this.getTableName(e.modelName);return e.indexes.forEach(e=>{t.push(s.build({type:"index",table:o,name:o+"_"+e,indexOn:e}).query)}),t}buildInsert(e,t){let i={type:a.Insert};return Object.assign(i,s.build({type:"insert",table:this.getTableName(e.modelName),values:t}))}buildDelete(e,t){let i={type:a.Delete};return Object.assign(i,s.build({type:"remove",table:this.getTableName(e.modelName),condition:this.getPrimaryKeyCondition(e,t)}))}buildUpdate(e,t,i,n){const r=this.getTableName(e.modelName);let o=this.getPrimaryKeyCondition(e,t);o._version_=n;let c={type:a.Update};return Object.assign(c,s.build({type:"update",table:r,modifier:i,condition:o}))}buildSelect(e,t,i,n,o,c){const l=this.getTableName(e.modelName);let h;if(r.isArray(t)){let s=t||e.fieldNames.map(t=>e.schemaObject.table+"."+t),a=r.isNumber(n)?{limit:n}:n||{},d=o||{};for(let e of Reflect.ownKeys(d)){let t=d[e]||-1;d[e]="ASC"===t?1:"DESC"===t?-1:t}h={type:"select",table:l,fields:s,condition:i,limit:a.limit,offset:a.offset,sort:d,join:c}}else{let e=t;h=Object.assign({type:"select",table:l},e)}let d={type:a.Select};return Object.assign(d,s.build(h))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(16),s=i(7),o=i(4),a=i(12),c=i(1),l=i(0);class h{constructor(e,t,i){this.log=c.LogManager.getLogger(h.name+(void 0===i?"":`_${i}`)),this.sessionSerial=-1,this.connection=e,this.models=new Map,this.sessionCache=new r.LRUEntityCache(t),this.sqlBuilder=new s.JsonSqlBuilder,this.entityTracker=new a.ProxiedEntityTracker(this.sessionCache),this.holdLocks=new Map,this.trackerSqlBuilder=new a.ProxiedTrackerSqlBuilder(this.entityTracker,this.models,this.sqlBuilder)}getSchemaByName(e){const t=this.models.get(e);if(!t)throw new Error(`unregistered model ( name = '${e}' )`);return t}getSchemaByClass(e){const t=this.models.get(e.name);if(!t)throw new Error(`unregistered model ( name = '${e.name}' )`);return t}getSchema(e){return"string"==typeof e?this.getSchemaByName(e):this.getSchemaByClass(e)}makeByKeyCondition(e,t){return e.setKey({},t)}trackPersistentEntities(e,t,i=!0,n=!1){let r=new Array;return t.forEach(t=>{let s=e.getKey(t),o=this.entityTracker.getTrackingEntity(e,s),a=n&&void 0!==o?o:this.entityTracker.trackPersistent(e,t);r.push(a),i&&this.entityCache.put(e.modelName,s,t)}),r}reset(e=!1){this.entityTracker.stopTrackAll(),e&&this.entityCache.clear()}undefinedIfDeleted(e){return e.__state__===o.EntityState.Deleted||e.__state__===o.EntityState.Transient?void 0:e}get isOpen(){return this.connection&&this.connection.isConnected}get entityCache(){return this.sessionCache}syncSchema(e){this.sqlBuilder.buildSchema(e).forEach(e=>{this.connection.executeSync(e)})}registerSchema(...e){e.forEach(e=>this.models.set(e.modelName,e))}close(){return n(this,void 0,void 0,function*(){this.reset(!0),yield this.connection.disconnect()})}attachHistory(e){this.entityTracker.attachHistory(e)}getAllCached(e,t){const i=this.getSchema(e);let n=new Map;new Array(...this.entityTracker.trackingEntities).filter(e=>e.__schema__.modelName===i.modelName&&e.__state__!==o.EntityState.Deleted&&e.__state__!==o.EntityState.Transient).forEach(e=>n.set(this.entityTracker.getModelAndKey(e),e));let r=this.entityCache.getAll(i.modelName,t);return r&&r.forEach(e=>{let t=this.entityTracker.makeModelAndKey(i,i.getKey(e));if(!n.has(t)){let r=this.entityTracker.trackPersistent(i,e);n.set(t,r)}}),t?[...n.values()].filter(t):[...n.values()]}attach(e,t){let i=this.entityTracker.getTrackingEntity(e,t);if(void 0!==i)return this.undefinedIfDeleted(i);let n=this.entityCache.get(e.modelName,t);return void 0===n?void 0:this.entityTracker.trackPersistent(e,n)}getAll(e,t=!1){return n(this,void 0,void 0,function*(){const i=this.getSchema(e);if(i.memCached&&this.entityCache.existsModel(i.modelName)){let e=this.entityCache.getAll(i.modelName)||[];return t?this.trackPersistentEntities(i,e,!1,!0):e}return yield this.getMany(e,{},t)})}getMany(e,t,i=!1,r=!0){return n(this,void 0,void 0,function*(){const n=this.getSchema(e),s=this.sqlBuilder.buildSelect(n,n.fieldNames,t);let o=yield this.connection.query(s.query,s.parameters);return r&&o.forEach(e=>this.entityCache.put(n.modelName,n.getKey(e),e)),i?this.trackPersistentEntities(n,o,!1):o})}query(e,t,i,r,s,o){return n(this,void 0,void 0,function*(){const n=this.getSchema(e),s=this.sqlBuilder.buildSelect(n,n.fieldNames,t,i,r,o);return yield this.connection.query(s.query,s.parameters)})}queryByJson(e,t){return n(this,void 0,void 0,function*(){const i=this.getSchema(e),n=this.sqlBuilder.buildSelect(i,t);return yield this.connection.query(n.query,n.parameters)})}exists(e,t){return n(this,void 0,void 0,function*(){const i=this.getSchema(e);let{query:n,parameters:r}=this.sqlBuilder.buildSelect(i,[],t);n=`select exists(${n.replace(s.MULTI_SQL_SEPARATOR,"")}) as exist`;const o=yield this.connection.query(n,r);return l.isArray(o)&&parseInt(o[0].exist)>0})}count(e,t){return n(this,void 0,void 0,function*(){let i=yield this.queryByJson(e,{fields:"count(*) as count",condition:t});return l.isArray(i)?parseInt(i[0].count):0})}create(e,t,i){if(!t)throw new Error("entity key can not be null or undefined");const n=this.getSchema(e);let r=n.newEntity(e,t);if(i&&n.copyProperties(r,i),void 0!==this.entityTracker.getTrackingEntity(n,t)||this.sessionCache.exists(n.modelName,t))throw new Error(`entity exists already ( model = '${n.modelName}' key = '${t}' )`);return this.entityTracker.trackNew(n,r)}loadEntityByKey(e,t){return n(this,void 0,void 0,function*(){const i=this.getSchemaByName(e),n=this.makeByKeyCondition(i,t),r=this.sqlBuilder.buildSelect(i,i.fieldNames,n),s=yield this.connection.query(r.query,r.parameters);if(s.length>1)throw new Error(`entity key is duplicated ( model = '${e}' key = '${t}' )`);return 1===s.length?s[0]:void 0})}load(e,t){return n(this,void 0,void 0,function*(){const i=this.loadCached(e,t,!0);if(void 0!==i)return i;const n="string"==typeof e?e:e.name,r=this.getSchemaByName(n);let s=this.entityTracker.getTrackingEntity(r,t);if(s)return this.undefinedIfDeleted(s);const o=yield this.loadEntityByKey(n,t);return void 0!==o?(this.sessionCache.put(n,t,o),this.entityTracker.trackPersistent(this.getSchemaByName(n),o)):void 0})}getChanges(){return this.entityTracker.getTrackingChanges()}loadCached(e,t,i=!1){const n="string"==typeof e?e:e.name,r=this.getSchemaByName(n),s=this.entityTracker.getTrackingEntity(r,t);if(s&&i)return this.undefinedIfDeleted(s);const o=this.sessionCache.get(n,t);return void 0!==o&&i?this.entityTracker.trackPersistent(r,o):o}lockInThisSession(e,t=!1){if(!this.holdLocks.has(e))return this.holdLocks.set(e,this.entityTracker.isConfirming),!0;if(!t)throw new Error(`${e} exists already`);return!1}saveChanges(e){return n(this,void 0,void 0,function*(){const t=e||++this.sessionSerial;this.log.traceEnabled&&this.log.trace(`BEGIN saveChanges ( serial = ${t} )`),this.entityTracker.isConfirming&&this.commitEntityTransaction();const i=this.trackerSqlBuilder.buildChangeSqls(),n=yield this.connection.beginTrans();try{return yield this.connection.executeBatch(i),yield n.commit(),this.entityTracker.acceptChanges(t),this.holdLocks.clear(),this.sessionSerial=t,this.log.traceEnabled&&this.log.trace(`SUCCESS saveChanges ( serial = ${t} )`),t}catch(e){throw this.log.errorEnaled&&this.log.error(`FAILD saveChanges ( serial = ${t} )`,e),yield n.rollback(),this.entityTracker.rejectChanges(),e}})}rollbackChanges(e){return n(this,void 0,void 0,function*(){if(this.sessionSerial<e)return this.sessionSerial;const t=this.sessionSerial;this.log.traceEnabled&&this.log.trace(`BEGIN rollbackChanges ( serial = ${e} )`);const i=this.trackerSqlBuilder.buildRollbackChangeSqls(e+1),n=yield this.connection.beginTrans();try{return yield this.connection.executeBatch(i),yield n.commit(),this.entityTracker.rollbackChanges(e+1),this.holdLocks.clear(),this.sessionSerial=e,this.log.traceEnabled&&this.log.trace(`SUCCESS rollbackChanges (serial : ${t} -> ${this.sessionSerial})`),this.sessionSerial}catch(e){throw this.log.errorEnaled&&this.log.error(`FAILD rollbackChanges (serial : ${t} -> ${this.sessionSerial})`,e),yield n.rollback(),e}})}clearHistoryBefore(e){return this.entityTracker.clearHistory(e)}get historyVersion(){return this.entityTracker.historyVersion}update(e){}delete(e){this.entityTracker.trackDelete(e.__schema__,e)}beginTransaction(){return n(this,void 0,void 0,function*(){return yield this.connection.beginTrans()})}beginEntityTransaction(){this.entityTracker.beginConfirm()}commitEntityTransaction(){this.entityTracker.confirm(),this.holdLocks.forEach((e,t)=>this.holdLocks[t]=!1)}rollbackEntityTransaction(){this.entityTracker.cancelConfirm();let e=new Array;this.holdLocks.forEach((t,i)=>t&&e.push(i)),e.forEach(e=>this.holdLocks.delete(e))}}t.DbSession=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BlockCache=class{constructor(e){this.cache=new Map,this.minHeight=-1,this.maxHeight=-1,this.maxCachedCount=e}isCached(e){return e>0&&e>=this.minHeight&&e<=this.maxHeight}get cachedHeightRange(){return{min:this.minHeight,max:this.maxHeight}}put(e){if(!this.isCached(e.height)&&this.maxHeight>=0&&e.height!==this.maxHeight+1)throw new Error("invalid block height");this.cache.set(e.height,e),this.maxHeight=e.height,this.cache.size>=this.maxCachedCount&&this.cache.delete(this.minHeight++)}get(e){return this.cache.get(e)}getById(e){for(const t of this.cache.values())if(t.id===e)return t}evit(e,t){let i=Math.min(e,t),n=Math.max(e,t);if(!(i>this.maxHeight||n<this.minHeight)){i=Math.max(i,this.minHeight),n=Math.min(n,this.minHeight);for(let e=i;e<=n;e++)this.cache.delete(e)}}}},function(e,t){e.exports=require("better-sqlite3")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(0),s=i(1),o=i(10);class a{constructor(){this.log=s.LogManager.getLogger(a.name)}open(e,t){let i={err:null,result:!0};try{this.db=new o(e),this.log.traceEnabled&&this.log.trace(`SUCCESS open ( db = ${e} )`)}catch(n){if(i={err:n,result:!1},this.log.errorEnaled&&this.log.error(`FAILD open ( db = ${e} )`,n),!t)throw n}return t&&t(i.err,i.result),i.result}get isConnected(){return this.db.open}asynOpen(e){return n(this,void 0,void 0,function*(){return r.promisify(this.open).call(this,e)})}close(e){let t={err:null,result:!0};try{this.db&&this.isConnected?(this.db.close(),this.log.traceEnabled&&this.log.trace("SUCCESS close")):this.log.infoEnabled&&this.log.info("closed already")}catch(i){if(t={err:i,result:!1},this.log.errorEnaled&&this.log.error("FAILD close",i),!e)throw i}return e&&e(t.err,t.result),t.result}asynClose(){return r.promisify(this.close).call(this)}execute(e,t,i){let n={err:null,result:{lastInsertRowId:"0",rowsEffected:0}};try{const r=this.db.prepare(e).run(t||[]);n.result={lastInsertRowId:r.lastInsertROWID.toString(),rowsEffected:r.changes},this.log.traceEnabled&&this.log.trace(`SUCCESS execute sql = ${e} param = ${JSON.stringify(t)}, effected = ${n.result.rowsEffected}`)}catch(r){if(n.err=r,this.log.errorEnaled&&this.log.error(`FAILD execute sql = ${e} param = ${JSON.stringify(t)}`,r),!i)throw r}return i&&i(n.err,n.result),n.result}query(e,t,i){let n={err:null,result:new Array};try{n.result=this.db.prepare(e).all(t||[]),this.log.traceEnabled&&this.log.trace(`SUCCESS query sql = ${e} param = ${JSON.stringify(t)}, result count = ${n.result.length}`)}catch(r){if(n.err=r,this.log.errorEnaled&&this.log.error(`FAILD query sql = ${e} param = ${JSON.stringify(t)}`,r),!i)throw r}return i&&i(n.err,n.result),n.result}executeBatch(e,t,i){let n,r={err:null,result:new Array};try{e.forEach(e=>{n=e;let i=this.execute(e.query,e.parameters);t&&t(i,e),r.result.push(i)})}catch(e){if(r.err=e,this.log.errorEnaled&&this.log.error(`FAILD executeBatch, sql = ${n.query} param = ${JSON.stringify(n.parameters)}`,e),!i)throw e}return i&&i(r.err,r.result),r.result}asynExecute(e,t){return n(this,void 0,void 0,function*(){return r.promisify(this.execute).call(this,e,t)})}asynQuery(e,t){return n(this,void 0,void 0,function*(){return r.promisify(this.query).call(this,e,t)})}asyncExecuteBatch(e,t){return r.promisify(this.executeBatch).call(this,e,t)}}t.SqliteWrapper=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(6),s=i(2),o=i(4);class a extends r.BaseEntityTracker{constructor(e){super(e,n.LogManager.getLogger(a.name)),this.proxy=new o.EntityProxy(this),this.allTrackingEntities=new Map,this.unconfirmedEntities=new Map}ensureNoTracking(e,t){const i=this.makeModelAndKey(e,e.getKey(t));if(this.allTrackingEntities.has(i))throw new Error(`entity model=${e.modelName} key=${e.getKey(t)} is tracking`)}getModelAndKey(e){return this.makeModelAndKey(e.__schema__,e.__schema__.getKey(e))}saveHistory(e,t,i){this.getHistoryByVersion(i,!0).set(this.getModelAndKey(e),t)}removeTrackingTransisentEntities(){let e=new Array;this.allTrackingEntities.forEach((t,i)=>t.__state__===o.EntityState.Transient&&e.push(i)),e.forEach(e=>this.allTrackingEntities.delete(e))}attach(e){const t=this.makeModelAndKey(e.__schema__,e.__schema__.getKey(e));if(this.allTrackingEntities.has(t))throw new Error("exists another tracked entity");this.allTrackingEntities.set(this.getModelAndKey(e),e)}getLastChanges(e){if(o.EntityProxy.isDirty(e))switch(e.__state__){case o.EntityState.New:return this.createNewOrDeleteChanges(e,e._version_,!0);case o.EntityState.Deleted:return this.createNewOrDeleteChanges(e,e._version_,!1);case o.EntityState.Modified:return e.__changes__;default:return}}get trackingEntities(){return this.allTrackingEntities.values()}isTracking(e,t){return this.allTrackingEntities.has(this.makeModelAndKey(e,t))}registerUnconfirmedEntity(e){const t=this.getModelAndKey(e);this.unconfirmedEntities.set(t,e)}get isConfirming(){return this.confirming}beginConfirm(){this.confirming=!0,this.log.traceEnabled&&this.log.trace("BEGIN beginConfirm")}confirm(){this.unconfirmedEntities.forEach(e=>{e.__state__===o.EntityState.New?this.confirmNew(e):e.__state__===o.EntityState.Modified?this.confirmModify(e):e.__state__===o.EntityState.Deleted&&this.confirmedDelete(e)}),this.unconfirmedEntities.clear(),this.removeTrackingTransisentEntities(),this.confirming=!1,this.log.traceEnabled&&this.log.trace("SUCCESS confirm ")}cancelConfirm(){this.unconfirmedEntities.forEach(e=>{e.__state__===o.EntityState.New?this.cancelUnconfirmedNew(e):e.__state__===o.EntityState.Modified?this.cancelUnconfirmedModify(e):e.__state__===o.EntityState.Deleted?this.cancelUnconfirmedDelete(e):e.__state__===o.EntityState.Transient&&this.cancelUnconfirmedDelete(e)}),this.unconfirmedEntities.clear(),this.removeTrackingTransisentEntities(),this.confirming=!1,this.log.traceEnabled&&this.log.trace("SUCCESS cancelConfirm ")}getTrackingEntity(e,t){const i=this.makeModelAndKey(e,t);return this.allTrackingEntities.has(i)?this.allTrackingEntities.get(i):void 0}trackNew(e,t){this.ensureNoTracking(e,t);let i=this.proxy.proxyNew(t,e,!this.isConfirming);return this.allTrackingEntities.set(this.getModelAndKey(i),i),this.confirming&&this.registerUnconfirmedEntity(i),i}trackDelete(e,t){let i=o.EntityProxy.convertToProxied(t);if(i.__state__!==o.EntityState.Deleted&&i.__state__!==o.EntityState.Transient)switch(this.confirming&&this.registerUnconfirmedEntity(i),i.__confirmed__=!this.confirming,i.__state__){case o.EntityState.New:i.__state__=o.EntityState.Transient;break;case o.EntityState.Modified:case o.EntityState.Persistent:i.__state__=o.EntityState.Deleted}}confirmNew(e){e.__confirmed__=!0}cancelUnconfirmedNew(e){e.__unconfirmedChanges__&&e.__unconfirmedChanges__.type===r.EntityChangeType.New?this.proxy.cancelChanges(e):e.__state__=o.EntityState.Transient,e.__confirmed__=!0}confirmModify(e){this.proxy.confirmChanges(e)}cancelUnconfirmedModify(e){this.proxy.cancelChanges(e)}confirmedDelete(e){e.__confirmed__=!0}cancelUnconfirmedDelete(e){if(e.__state__===o.EntityState.Transient)e.__state__=o.EntityState.New;else if(e.__state__===o.EntityState.Deleted){let t=e.__changes__&&e.__changes__.propertiesChanges.length>0;e.__state__=t?o.EntityState.Modified:o.EntityState.Persistent}e.__unconfirmedChanges__&&(e.__unconfirmedChanges__.propertiesChanges=new Array),e.__confirmed__=!0}trackPersistent(e,t){this.ensureNoTracking(e,t);let i=this.proxy.proxyPersistent(t,e,!this.confirming);return this.allTrackingEntities.set(this.getModelAndKey(i),i),i}stopTrack(e,t){this.allTrackingEntities.delete(this.makeModelAndKey(e,e.getKey(t)))}stopTrackAll(){this.allTrackingEntities.clear()}getTrackingChanges(){let e=new Array;return this.allTrackingEntities.forEach(t=>{o.EntityProxy.isDirty(t)&&e.push({modelAndKey:this.getModelAndKey(t),changes:this.getLastChanges(t)})}),e}detectChanges(){let e=new Array;return this.allTrackingEntities.forEach(t=>{o.EntityProxy.isDirty(t)&&e.push({entity:t,changes:this.getLastChanges(t)})}),e}createNewOrDeleteChanges(e,t,i=!0){let n=new Array;for(const t in e)o.EntityProxy.isNormalProperty(t)&&n.push(i?{name:t,original:void 0,current:e[t]}:{name:t,original:e[t],current:void 0});return{type:i?r.EntityChangeType.New:r.EntityChangeType.Delete,dbVersion:t,propertiesChanges:n}}markStateAndSaveHistory(e,t){switch(e.__state__){case o.EntityState.New:this.log.traceEnabled&&this.log.trace(`NEW Version = ${t} entity = ${JSON.stringify(o.EntityProxy.proxyToEntity(e))}`),this.saveHistory(e,this.createNewOrDeleteChanges(e,e._version_,!0),t),e.__state__=o.EntityState.Persistent;break;case o.EntityState.Deleted:this.log.traceEnabled&&this.log.trace(`DELETE Version = ${t} entity = ${JSON.stringify(o.EntityProxy.proxyToEntity(e))}`),this.saveHistory(e,this.createNewOrDeleteChanges(e,e._version_,!1),t),e.__state__=o.EntityState.Transient;break;case o.EntityState.Modified:this.log.traceEnabled&&this.log.trace(`MODIFIED Version = ${t} changes = ${JSON.stringify(e.__changes__)} unconfirmed = ${JSON.stringify(e.__unconfirmedChanges__)}`),e.__state__=o.EntityState.Persistent,this.saveHistory(e,e.__changes__,t),e.__changes__=null;break;case o.EntityState.Persistent:case o.EntityState.Transient:}}acceptChanges(e){this.log.traceEnabled&&this.log.trace(`BEGIN acceptChanges Version = ${e}`),this.allTrackingEntities.forEach(t=>{const i=t.__schema__;t.__state__===o.EntityState.New||t.__state__===o.EntityState.Modified?this.cache.put(i.modelName,i.getKey(t),o.EntityProxy.proxyToEntity(t)):t.__state__===o.EntityState.Deleted&&this.cache.evit(i.modelName,i.getKey(t)),this.markStateAndSaveHistory(t,e),this.currentVersion=e,t.__detached__=!0}),this.allTrackingEntities.clear(),this.minVersion=-1===this.minVersion?e:this.minVersion,this.log.traceEnabled&&this.log.trace(`SUCCESS acceptChanges Version = ${e}`)}rejectChanges(){this.cancelConfirm(),this.allTrackingEntities.forEach(e=>{switch(e.__state__){case o.EntityState.New:e.__state__=o.EntityState.Transient;break;case o.EntityState.Modified:e.__tracking__=!1,e.__changes__.propertiesChanges.forEach(t=>e[t.name]=t.original),e.__tracking__=!0,e.__changes__=null,e.__state__=o.EntityState.Persistent;break;case o.EntityState.Deleted:e.__state__=o.EntityState.Persistent;break;case o.EntityState.Persistent:case o.EntityState.Transient:}}),this.log.traceEnabled&&this.log.trace("rejectChanges Version = ?")}rollbackChanges(e){const t=this.currentVersion;for(this.log.traceEnabled&&this.log.trace(`BEGIN rollbackChanges Version : ${t} -> ${e}`),this.rejectChanges();e<=this.currentVersion;){const e=this.getHistoryByVersion(this.currentVersion);e&&e.forEach((e,t)=>{const i=this.splitModelAndKey(t);this.rollbackCacheChanges(i.model,i.key,e)}),this.currentVersion--}this.allTrackingEntities.forEach(e=>e.__detached__=!0),this.allTrackingEntities.clear(),this.minVersion=Math.min(this.minVersion,this.currentVersion),this.log.traceEnabled&&this.log.trace(`SUCCESS rollbackChanges Version : ${t} -> ${this.currentVersion}`)}dumpChanges(e){let t="";return e.propertiesChanges.forEach(e=>t+=`${e.name}: ${e.original} -> ${e.current}, `),`dbVersion=${e.dbVersion}, type=${e.type}, [${t}]`}dumpHistory(){let e=this.currentVersion,t="--------------  DUMP HISTORY  ----------------\n\n";for(;e>=this.minVersion;){t+=`--------------version ${e}----------------\n`;let i=this.getHistoryByVersion(e);i&&i.forEach((e,i)=>{let n=this.dumpChanges(e);const r=this.splitModelAndKey(i),s=`type=${r.model}, key=${r.key}, changes={${n}} \n`;t+=s}),t+="\n",e--}return t+="--------------   END   DUMP  ----------------\n"}}t.ProxiedEntityTracker=a;t.ProxiedTrackerSqlBuilder=class{constructor(e,t,i){this.tracker=e,this.models=t,this.sqlBuilder=i}get entityTracker(){return this.tracker}buildChangeSqls(){let e=new Array;return this.tracker.detectChanges().forEach(t=>{e.push(this.buildSqlAndParameters(t.entity))}),e}buildSqlAndParameters(e){switch(e.__state__){case o.EntityState.New:const t=o.EntityProxy.proxyToEntity(e,!0);return this.sqlBuilder.buildInsert(e.__schema__,t);case o.EntityState.Modified:let i=this.tracker.getLastChanges(e),n=s.makeJsonObject(i.propertiesChanges,e=>e.name,e=>e.current);return this.sqlBuilder.buildUpdate(e.__schema__,e.__schema__.getKey(e),n,i.dbVersion-1);case o.EntityState.Deleted:return this.sqlBuilder.buildDelete(e.__schema__,e.__schema__.getKey(e));default:throw new Error(`Invalid entity state '${e.__state__}'`)}}buildRollbackChangeSqls(e){let t=new Array;return this.tracker.getChangesUntil(e).forEach(e=>e.forEach((e,i)=>{const n=this.tracker.splitModelAndKey(i),o=this.models.get(n.model);switch(e.type){case r.EntityChangeType.New:t.push(this.sqlBuilder.buildDelete(o,n.key));break;case r.EntityChangeType.Modify:let i=s.makeJsonObject(e.propertiesChanges,e=>e.name,e=>e.original);t.push(this.sqlBuilder.buildUpdate(o,n.key,i,e.dbVersion));break;case r.EntityChangeType.Delete:let a=s.makeJsonObject(e.propertiesChanges,e=>e.name,e=>e.original);t.push(this.sqlBuilder.buildInsert(o,a))}})),t}}},function(e,t){e.exports=require("change-case")},function(e,t){e.exports=require("json-sql")},function(e,t){e.exports=require("lru-cache")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(15),r=i(2),s=i(1),o=i(0);class a{constructor(e){this.options=e||{default:a.DEFULT_MAX_CACHED_COUNT},this.log=s.LogManager.getLogger(a.name),this.modelCaches=new Map}getModelCache(e,t=!1,i=!1){if(t&&!this.modelCaches.has(e)){let t;t=this.options.hasOwnProperty(e)?o.isNumber(this.options[e])?Number(this.options[e]):o.isFunction(this.options[e])?this.options[e](e):a.DEFULT_MAX_CACHED_COUNT:this.options.default,t=Math.max(a.MIN_CACHED_COUNT,t),this.modelCaches.set(e,new n(t))}if(i&&!this.modelCaches.has(e))throw new Error(`Model cache ( name = '${e}' )  does not exists`);return this.modelCaches.get(e)}getCacheKey(e){return r.isPrimitiveKey(e)?e:e.key}clear(e){if(o.isString(e))return this.getModelCache(e,!1,!0).reset(),void this.modelCaches.delete(e);for(let e of this.modelCaches.values())e.reset();this.modelCaches.clear()}get models(){let e=new Array;for(let t of this.modelCaches.keys())e.push(t);return e}get(e,t){let i=this.getModelCache(e),n=this.getCacheKey(t);return this.modelCaches.has(e)&&i.has(n)?i.get(n):void 0}getAll(e,t){let i=new Array,n=this.getModelCache(e);if(void 0!==n)return n.forEach(e=>{(!t||t&&t(e))&&i.push(e)}),i}put(e,t,i){this.log.traceEnabled&&this.log.trace(`put cache, model = ${e}, key = ${t}, entity = ${JSON.stringify(i)}`),this.getModelCache(e,!0).set(this.getCacheKey(t),i)}evit(e,t){let i=this.getCacheKey(t);this.log.traceEnabled&&this.log.trace(`evit cache, model = ${e}, key = ${i}`);const n=this.getModelCache(e);n&&n.del(i)}exists(e,t){return void 0!==this.get(e,this.getCacheKey(t))}existsModel(e){return void 0!==this.getModelCache(e,!1,!1)}dumpCache(){let e="--------------  DUMP CACHE  ----------------\n\n";return this.modelCaches.forEach((t,i)=>{e+=`--------------Model ${i}----------------\n`,t.forEach((t,i)=>{e+=`key = ${this.getCacheKey(i)}, entity = {${JSON.stringify(t)}} \n`}),e+="\n"}),e+="--------------   END   DUMP  ----------------\n"}}a.MIN_CACHED_COUNT=100,a.DEFULT_MAX_CACHED_COUNT=1e4,t.LRUEntityCache=a},function(e,t){e.exports=require("level-secondary")},function(e,t){e.exports=require("level")},function(e,t){e.exports=require("level-sublevel")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(0),s=i(19),o=i(18),a=i(17);function c(e){let t=null;return e||(t=(e=function(){let e,t=new Promise((t,i)=>{e=((e,n)=>e?i(e):t(n))});return e.promise=t,e}()).promise),{callback:e,promise:t}}t.SubLevelMeta=class{constructor(e,t,i=new Array){this.subName=e,this.keyField=t,this.indexFields=(new Array).concat(i)}findIndexOfFieldName(e){return this.indexFields.findIndex(t=>e===t.fieldName)}existsIndex(e){return this.findIndexOfFieldName(e)>-1}addIndex(e,t){if(this.existsIndex(e))throw new Error(`Index of field '${e}' already exists`);return this.indexFields.push({fieldName:e,calcIndex:t}),this}removeIndex(e){const t=this.findIndexOfFieldName(e);return t>-1&&this.indexFields.slice(t,1),this}};class l{constructor(e,t,i={}){this.dbDir=e,this.subMetas=(new Array).concat(t),this.subLevels=new Map,this.leveldb=null}init(){return n(this,void 0,void 0,function*(){this.leveldb=o(this.dbDir,{valueEncoding:"json"}),this.subLeveldb=s(this.leveldb),this.subMetas.forEach(e=>this.registerSubLevel(e))})}registerSubLevel(e){const t=this.subLeveldb.sublevel(e.subName),i=new h(t,e.subName,e.keyField,...e.indexFields);this.subLevels.set(e.subName,i)}static isKeyNotFoundError(e){return e&&"NotFoundError"===e.name}get level(){return this.leveldb}getSubLevel(e){const t=this.subLevels.get(e);if(!t)throw new Error(`No such subLevel name = '${e}'`);return t}open(e){let t=this,{callback:i,promise:r}=c(e);return this.isOpen?(process.nextTick(i,null,t),r):((()=>n(this,void 0,void 0,function*(){try{yield this.init(),process.nextTick(i,null,t)}catch(e){process.nextTick(i,e,t)}}))(),r)}close(e){let t=this,{callback:i,promise:r}=c(e);return this.isClosed?(process.nextTick(i,null,t),r):((()=>n(this,void 0,void 0,function*(){try{yield this.leveldb.close(),this.leveldb=null,process.nextTick(i,null,t)}catch(e){process.nextTick(i,e)}}))(),r)}get isOpen(){return this.leveldb&&this.leveldb.isOpen()}get isClosed(){return!this.leveldb||this.leveldb.isClosed()}dump(){return new Promise((e,t)=>{let i=new Array;this.leveldb.createReadStream().on("data",e=>i.push(`key= ${e.key}, value= ${e.value}`)).on("error",e=>t(e)).on("end",()=>e(i.join("\r\n")))})}}t.LevelDB=l;class h{get name(){return this.subName}get indexes(){return this.indexArray}constructor(e,t,i,...n){this.subLevelDb=e,this.subName=t,this.keyField=i,this.indexArray=(new Array).concat(...n),this.indexedSubLevels=new Map,this.indexArray.forEach(t=>{let i=a(e,t.fieldName,t.calcIndex);this.indexedSubLevels.set(t.fieldName,i)})}get key(){return this.keyField}keyNotFoundThenUndefined(e){return e?(t,i)=>{e(l.isKeyNotFoundError(t)?null:t,i)}:void 0}get(e,t,i){return n(this,void 0,void 0,function*(){const n=this.subLevelDb;let{callback:r,promise:s}=c(i);try{n.get(e,t,this.keyNotFoundThenUndefined(r))}catch(e){r(l.isKeyNotFoundError(e)?void 0:e,void 0)}return s})}byIndex(e){const t=this.indexedSubLevels.get(e);if(!t)throw new Error(`No such index field = '${e}'`);return t}getBy(e,t,i){return n(this,void 0,void 0,function*(){const n=this.byIndex(e);let{callback:r,promise:s}=c(i);try{n.get(t,this.keyNotFoundThenUndefined(r))}catch(e){r(l.isKeyNotFoundError(e)?void 0:e,void 0)}return s})}put(e,t,i){return n(this,void 0,void 0,function*(){let{callback:n,promise:r}=c(i);try{this.subLevelDb.put(e,t,n)}catch(e){n(e,void 0)}return r})}del(e,t){return n(this,void 0,void 0,function*(){let{callback:i,promise:n}=c(t);try{this.subLevelDb.del(e,i)}catch(e){i(e,void 0)}return n})}batch(e,t,i){return n(this,arguments,void 0,function*(){if(0===arguments.length)return this.subLevelDb.batch();let n=t&&!r.isFunction(t),s=n?i:t,{callback:o,promise:a}=c(s);try{n?this.subLevelDb.batch(e,t,o):this.subLevelDb.batch(e,o)}catch(e){o(e,void 0)}return a})}createReadStream(e){return this.subLevelDb.createReadStream(e)}createKeyStream(e){return this.subLevelDb.createKeyStream(e)}createValueStream(e){return this.subLevelDb.createValueStream(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(20),s="__last_block_height__";t.LevelBlock=class{constructor(e,t={}){const i=new r.SubLevelMeta("blk","height",[{fieldName:"id"},{fieldName:"delegate"}]),n=new r.SubLevelMeta("his","height",[]);this.db=new r.LevelDB(e,[i,n],t),this.lastHeight=-1}getLastBlockHeightFromDb(){return n(this,void 0,void 0,function*(){let e=yield this.blockDb.get(s,{});return void 0===e&&(e=this.getLastHeightJson(-1),yield this.blockDb.put(s,e)),e.height})}open(){return n(this,void 0,void 0,function*(){yield this.db.open(),this.blockDb=this.db.getSubLevel("blk"),this.historyDb=this.db.getSubLevel("his"),this.lastHeight=yield this.getLastBlockHeightFromDb()})}close(){return n(this,void 0,void 0,function*(){yield this.db.close()})}get lastBlockHeight(){return this.lastHeight}isKeyNotFoundError(e){return"NotFoundError"===e.name}getLastHeightJson(e){return{height:e,id:"NULL",delegate:"NULL"}}appendBlock(e,t){return n(this,void 0,void 0,function*(){if(!e||!e.id||!e.delegate||void 0===e.height)throw new Error("Invalid block data");yield this.historyDb.put(e.height,t),yield this.blockDb.batch([{type:"put",key:e.height,value:e},{type:"put",key:s,value:this.getLastHeightJson(e.height)}]),this.lastHeight=e.height})}getBlock(e){return n(this,void 0,void 0,function*(){try{return yield this.blockDb.get(e)}catch(e){if(!this.isKeyNotFoundError(e))throw e}})}getHistoryChanges(e,t){return n(this,void 0,void 0,function*(){let i=new Map;for(let n=e;n<t;n++){const e=yield this.historyDb.get(n);e&&i.set(n,e)}return i})}deleteLastBlock(e){return n(this,void 0,void 0,function*(){if(e!==this.lastBlockHeight)throw new Error(`invalid last block height '${e}'`);yield this.blockDb.batch([{type:"del",key:e},{type:"put",key:s,value:this.getLastHeightJson(e-1)}]),yield this.historyDb.del(e),this.lastHeight--})}getBlockById(e){return n(this,void 0,void 0,function*(){return yield this.blockDb.getBy("id",e)})}getBlocksByHeightRange(e,t){return n(this,void 0,void 0,function*(){let i=new Array;for(let n=e;n<=t;n++){let e=yield this.getBlock(n);e&&i.push(e)}return i})}getBlocksByIds(e){return n(this,void 0,void 0,function*(){let t=new Array;for(let i=0;i<e.length;i++){let n=yield this.getBlockById(e[i]);n&&t.push(n)}return t})}}},function(e,t){e.exports=require("events")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(o,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=i(22),s=i(0),o=i(2),a=i(21),c=i(8),l=i(5),h=i(3),d=i(1),u=i(4),g=i(9);class y extends r.EventEmitter{constructor(e,t,i){o.CodeContract.argument("dbPath",()=>o.CodeContract.notNullOrWhitespace(e)),o.CodeContract.argument("levelBlockDir",()=>o.CodeContract.notNullOrWhitespace(t)),super(),this.options={cachedBlockCount:10,historyForRollback:10,autoCleanPersistedHistory:!1,entityCacheOptions:{default:5e3}}||i,this.commitBlockHooks=new Array,this.rollbackBlockHooks=new Array,this.schemas=new Map,this.log=d.LogManager.getLogger(y.name),this.blockDB=new a.LevelBlock(t),this.cachedBlocks=new g.BlockCache(this.options.cachedBlockCount),this.connection=new l.SqliteConnection({storage:e}),this.blockSession=new c.DbSession(this.connection,this.options.entityCacheOptions,"Block"),this.localSession=new c.DbSession(this.connection,this.options.entityCacheOptions,"Local")}getSchema(e,t=!1,i=!1){const n=s.isString(e)?String(e):e.name;let r=this.schemas.get(n);return t&&o.CodeContract.verify(void 0!==r,`unregistered model '${n}'`),i&&o.CodeContract.verify(!r.isReadonly,`model '${n}' is readonly`),r}getSession(e){return e.isLocal?this.localSession:this.blockSession}preCommitBlock(e){this.commitBlockHooks.forEach(t=>t.hook(e))}postCommitBlock(e){this.emit("newBlock",e)}preRollbackBlock(e,t){this.rollbackBlockHooks.forEach(i=>i.hook(e,t))}postRollbackBlock(e,t){this.emit("rollbackBlock",{from:e,to:t})}registerCommitBlockHook(e,t){o.CodeContract.argument("hookFunc",()=>o.CodeContract.notNull(t)),o.CodeContract.argument("name",()=>o.CodeContract.notNullOrWhitespace(e)),o.CodeContract.argument("name",void 0===this.commitBlockHooks.find(t=>t.name===e.trim()),`hook named '${e}' exist already`),this.commitBlockHooks.push({name:e,hook:t})}unregisterCommitBlockHook(e){o.CodeContract.argument("name",()=>o.CodeContract.notNullOrWhitespace(e));let t=this.commitBlockHooks.findIndex(t=>t.name===e.trim());t>=0&&this.commitBlockHooks.slice(t)}registerRollbackBlockHook(e,t){o.CodeContract.argument("hookFunc",()=>o.CodeContract.notNull(t)),o.CodeContract.argument("name",()=>o.CodeContract.notNullOrWhitespace(e)),o.CodeContract.argument("name",void 0===this.rollbackBlockHooks.find(t=>t.name===e.trim()),`hook named '${e}' exist already`),this.rollbackBlockHooks.push({name:e,hook:t})}unregisterRollbackBlockHook(e){o.CodeContract.argument("name",()=>o.CodeContract.notNullOrWhitespace(e));let t=this.rollbackBlockHooks.findIndex(t=>t.name===e.trim());t>=0&&this.rollbackBlockHooks.slice(t)}init(e){return n(this,void 0,void 0,function*(){o.CodeContract.argument("schemas",()=>o.CodeContract.notNull(e)),yield this.connection.connect(),yield this.blockDB.open();for(const t of e){this.schemas.set(t.modelName,t);let e=this.getSession(t);if(e.registerSchema(t),e.syncSchema(t),this.log.infoEnabled&&this.log.info(`sync schema model = ${t.modelName} `),t.memCached){let i=yield e.getMany(t.modelName,{},!1,!0);this.log.infoEnabled&&this.log.info(`model ${t.modelName} cached ${i.length} entities `)}}this.emit("ready",this)})}close(){return n(this,void 0,void 0,function*(){yield this.blockSession.close(),yield this.localSession.close(),yield this.blockDB.close(),this.emit("closed",this)})}get lastBlockHeight(){return this.blockDB.lastBlockHeight}get blocksCount(){return this.lastBlockHeight+1}get lastBlock(){return this.cachedBlocks.get(this.lastBlockHeight)}lockInCurrentBlock(e,t=!1){return this.blockSession.lockInThisSession(e,t)}beginContract(){this.blockSession.beginEntityTransaction()}commitContract(){this.blockSession.commitEntityTransaction()}rollbackContract(){this.blockSession.rollbackEntityTransaction()}beginBlock(e){o.CodeContract.argument("block",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("block",e.height===this.lastBlockHeight+1,`invalid block height ${e.height}, last = ${this.lastBlockHeight}`),this.log.infoEnabled&&this.log.info(`BEGIN block height = ${e.height}`),this.currentBlock=e}commitBlock(){return n(this,void 0,void 0,function*(){if(!this.currentBlock)throw new Error("Current block is null");this.log.traceEnabled&&this.log.trace(`BEGIN commitBlock height = ${this.currentBlock.height}`),this.preCommitBlock(this.currentBlock);let e=Object.assign({},this.currentBlock);Reflect.deleteProperty(e,"transactions"),yield this.blockDB.appendBlock(e,this.blockSession.getChanges());try{return yield this.blockSession.saveChanges(this.currentBlock.height),this.blockSession.clearHistoryBefore(this.currentBlock.height-this.options.historyForRollback),this.cachedBlocks.put(this.currentBlock),this.currentBlock=null,this.postCommitBlock(this.lastBlock),this.log.infoEnabled&&this.log.info(`SUCCESS commitBlock height = ${this.lastBlockHeight}`),this.lastBlockHeight}catch(e){throw this.log.errorEnaled&&this.log.error(`FAILD commitBlock ( height = ${this.currentBlock.height} )`,e),yield this.blockDB.deleteLastBlock(this.currentBlock.height),e}})}rollbackBlock(e){return n(this,void 0,void 0,function*(){o.CodeContract.argument("height",!e||e<=this.lastBlockHeight,`height must less or equal lastBlockHeight ${this.lastBlockHeight}`);const t=this.currentBlock?this.currentBlock.height:this.lastBlockHeight,i=void 0===e?this.lastBlockHeight:e;this.log.traceEnabled&&this.log.trace(`BEGIN rollbackBlock ( height : ${t} -> ${i} )`),this.preRollbackBlock(t,i);try{const e=this.blockSession.historyVersion;if(t<e.min){let i=yield this.blockDB.getHistoryChanges(t,e.min);this.blockSession.attachHistory(i)}for(yield this.blockSession.rollbackChanges(i);this.lastBlockHeight>i;)yield this.blockDB.deleteLastBlock(this.lastBlockHeight),this.cachedBlocks.evit(this.lastBlockHeight,this.lastBlockHeight);this.currentBlock=null,this.postRollbackBlock(t,i),this.log.infoEnabled&&this.log.info(`SUCCESS rollbackBlock ( height : ${t} -> ${i} )`)}catch(e){throw this.log.errorEnaled&&this.log.error(`FAILD rollbackBlock ( height : ${t} -> ${i} )`,e),e}})}saveLocalChanges(){return n(this,void 0,void 0,function*(){let e=yield this.localSession.saveChanges();return this.localSession.clearHistoryBefore(e),e})}rollbackLocalChanges(e){return n(this,void 0,void 0,function*(){o.CodeContract.argument("serial",e>=0,"serial must great or equal zero"),yield this.localSession.rollbackChanges(e),this.localSession.clearHistoryBefore(e)})}getEntityKey(e,t){return o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("entity",()=>o.CodeContract.notNull(t)),this.getSchema(e,!0).getKey(t)}attach(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("entity",()=>o.CodeContract.notNull(t));let i=this.getEntityKey(e,t);o.CodeContract.argument("entity",void 0!==i,"can not get entity key");let n=this.getSchema(e,!0,!0);return this.getSession(n).load(e,i)})}create(e,t){let i,n;o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("keyOrEntity",()=>o.CodeContract.notNull(t));let r=this.getSchema(e,!0,!0);return o.isPrimitiveKey(t)||h.isCompositeKey(t)?i=t:(n=t,i=r.getKey(n)),this.getSession(r).create(e,i,n)}delete(e,t){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("entity",t&&u.EntityProxy.isProxied(t),"is not a tracking entity");let i=this.getSchema(e,!0,!0);this.getSession(i).delete(t)}get(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("key",()=>o.CodeContract.notNull(t));let i=this.getSchema(e,!0);return yield this.getSession(i).load(e,t)})}getBy(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("condition",()=>o.CodeContract.notNull(t));let i=this.getSchema(e,!0),n=yield this.getSession(i).getMany(e,t,!1,!0);if(n.length>1)throw new Error(`many entities found ( model = '${i.modelName}', condition = '${JSON.stringify(t)}' )`);return 0===n.length?void 0:this.attach(e,n[0])})}getMany(e,t,i=!1){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let n=this.getSchema(e,!0);return yield this.getSession(n).getMany(e,t,i)})}getCached(e,t){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e)),o.CodeContract.argument("key",()=>o.CodeContract.notNull(t));let i=this.getSchema(e,!0);return this.getSession(i).loadCached(e,t,!0)}getAllCached(e,t){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let i=this.getSchema(e,!0);return this.getSession(i).getAllCached(e,t)}find(e,t,i,r,s,a){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let n=this.getSchema(e,!0);return yield this.getSession(n).query(e,t,i,r,s,a)})}findOne(e,t){return n(this,void 0,void 0,function*(){let i=yield this.findAll(e,t),n=this.getSchema(e,!0);if(i.length>1)throw new Error(`many entities found ( model = '${n.modelName}' , params = '${JSON.stringify(t)}' )`);return 0===i.length?void 0:i[0]})}findAll(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let i=this.getSchema(e,!0);return yield this.getSession(i).queryByJson(e,t)})}exists(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let i=this.getSchema(e,!0);return yield this.getSession(i).exists(e,t)})}count(e,t){return n(this,void 0,void 0,function*(){o.CodeContract.argument("model",()=>o.CodeContract.notNull(e));let i=this.getSchema(e,!0);return yield this.getSession(i).count(e,t)})}attachTransactions(e,t){return n(this,void 0,void 0,function*(){let i=new Map;return(yield t()).forEach(e=>{i.has(e.blockId)||i.set(e.blockId,new Array),i.get(e.blockId).push(e)}),e.forEach(e=>e.transactions=i.get(e.id)),e})}copyCachedBlock(e,t){let i=e();if(void 0===i)return;let n=Object.assign({},i);return t||Reflect.deleteProperty(n,"transactions"),n}getBlockByHeight(e,t=!1){return n(this,void 0,void 0,function*(){o.CodeContract.argument("height",e>=0,"height must great or equal zero");let i=this.copyCachedBlock(()=>this.cachedBlocks.get(e),t);if(i)return i;let r=yield this.blockDB.getBlock(e);return t&&void 0!==r?yield this.attachTransactions([r],()=>n(this,void 0,void 0,function*(){return yield this.blockSession.query("Transaction",{blockId:r.id})}))[0]:r})}getBlockById(e,t=!1){return n(this,void 0,void 0,function*(){o.CodeContract.argument("blockId",()=>o.CodeContract.notNullOrWhitespace(e));let i=this.copyCachedBlock(()=>this.cachedBlocks.getById(e),t);if(i)return i;let r=yield this.blockDB.getBlockById(e);return t&&void 0!==r?yield this.attachTransactions([r],()=>n(this,void 0,void 0,function*(){return yield this.blockSession.query("Transaction",{blockId:r.id})}))[0]:r})}getBlocksByHeightRange(e,t,i=!1){return n(this,void 0,void 0,function*(){o.CodeContract.argument("minHeight, maxHeight",e>=0&&t>=e,"minHeight or maxHeight is invalid");let r=yield this.blockDB.getBlocksByHeightRange(e,t);return i?yield this.attachTransactions(r,()=>n(this,void 0,void 0,function*(){return yield this.blockSession.query("Transaction",{blockId:{$in:r.map(e=>e.id)}})})):r})}getBlocksByIds(e,t=!1){return n(this,void 0,void 0,function*(){o.CodeContract.argument("blockIds",()=>o.CodeContract.notNull(e));let i=yield this.blockDB.getBlocksByIds(e);return t?yield this.attachTransactions(i,()=>n(this,void 0,void 0,function*(){return yield this.blockSession.query("Transaction",{blockId:{$in:i.map(e=>e.id)}})})):i})}}t.SmartDB=y},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(23),r=i(3),s=i(8),o=i(5),a=i(1);!function(e){e.SmartDB=n.SmartDB,e.ModelSchema=r.ModelSchema,e.LogManager=a.LogManager,e.LogLevel=a.LogLevel,e.DbSession=s.DbSession,e.SqliteConnection=o.SqliteConnection}(t.AschCore||(t.AschCore={}))}]);